<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Building a TFRecords dataset | Joao Lage</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Building a TFRecords dataset" />
<meta name="author" content="Joao Lage" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How do I changed my dataset creation method" />
<meta property="og:description" content="How do I changed my dataset creation method" />
<link rel="canonical" href="https://joaolage.com/building-tfrecords-dataset/" />
<meta property="og:url" content="https://joaolage.com/building-tfrecords-dataset/" />
<meta property="og:site_name" content="Joao Lage" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-09-17T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Building a TFRecords dataset" />
<meta name="twitter:site" content="@_joaolage" />
<meta name="twitter:creator" content="@Joao Lage" />
<script type="application/ld+json">
{"url":"https://joaolage.com/building-tfrecords-dataset/","@type":"BlogPosting","headline":"Building a TFRecords dataset","dateModified":"2019-09-17T00:00:00-05:00","datePublished":"2019-09-17T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://joaolage.com/building-tfrecords-dataset/"},"author":{"@type":"Person","name":"Joao Lage"},"description":"How do I changed my dataset creation method","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://joaolage.com/feed.xml" title="Joao Lage" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Joao Lage</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Building a TFRecords dataset</h1><p class="page-description">How do I changed my dataset creation method</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2019-09-17T00:00:00-05:00" itemprop="datePublished">
        Sep 17, 2019
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Joao Lage</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#tensorflow">tensorflow</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#keras">keras</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#ml">ml</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h1"><a href="#creating-the-dataset">Creating the Dataset</a>
<ul>
<li class="toc-entry toc-h3"><a href="#how-do-i-start">How do I start?</a></li>
<li class="toc-entry toc-h2"><a href="#how-do-i-create-a-tfrecords-file">How do I create a TFRecords file?</a></li>
<li class="toc-entry toc-h2"><a href="#how-do-i-read-a-tfrecord-file">How do I read a TFRecord file?</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#fitting-a-model">Fitting a model</a></li>
</ul><h1 id="introduction">
<a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<blockquote>
  <p>For a long time I worked with pickle, JSON and CSV files in order to build a dataset that could be used to train a ML model.</p>
</blockquote>

<p>We all know the importance to have reliable, reusable and portable datasets when training any model.</p>

<p>As we know, pickle files show some disadvantages:</p>

<ul>
  <li>No compression</li>
  <li>Assumes you will have the same packages when decoding the file (example: numpy)</li>
  <li>You cannot stream it from disk since you have to read and decode the file/part as a whole first</li>
</ul>

<p><strong>What happens next?</strong> - Let me present you TFRecords!</p>

<h1 id="creating-the-dataset">
<a class="anchor" href="#creating-the-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating the Dataset</h1>

<p>What is a TFRecords file?</p>

<blockquote>
  <p>“To read data efficiently it can be helpful to serialize your data and store it in a set of files (…)”
src: <a href="https://www.tensorflow.org/tutorials/load_data/tf_records">TFRecords tutorials</a></p>
</blockquote>

<p>TFRecords take advantage of <a href="https://developers.google.com/protocol-buffers/">protocol buffers</a> to efficiently create a cross-platform structure of the data to be saved. The saved data is a sequence of binary records.</p>

<h3 id="how-do-i-start">
<a class="anchor" href="#how-do-i-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>How do I start?</h3>
<p>Let’s pretend our dataset is made of images, descriptions and labels. Labels will be our targets for future use.
First we will need to define a protobuf and <code class="language-plaintext highlighter-rouge">tf.train.Example</code> will ease that work for us:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>


<span class="k">def</span> <span class="nf">serialize_example</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"description_index"</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">description</span><span class="p">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s">"description_value"</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">description</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s">"image"</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">bytes_list</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">image</span><span class="p">])</span>
        <span class="p">),</span>
        <span class="s">"label"</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">label</span><span class="p">])),</span>
    <span class="p">}</span>

    <span class="n">example_proto</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">example_proto</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">()</span>
</code></pre></div></div>

<p>The above snippet creates a structure holding a sparse vector representation for textual descriptions, a byte string for images and a list for labels . If you want to encode your text as a sequence you can easily do it without the need of having both indices and values - just values will be enough.</p>

<p>In regard to images, this example assumes that each image was downloaded, resized and saved previously into disk and can be loaded through its image path.</p>

<p>At the moment, TFRecords support <a href="https://www.tensorflow.org/tutorials/load_data/tf_records#data_types_for_tfexample">three generic types</a>, <code class="language-plaintext highlighter-rouge">BytesList</code>, <code class="language-plaintext highlighter-rouge">FloatList</code> and <code class="language-plaintext highlighter-rouge">Int64List</code>, but they can be coerced into many other data types.</p>

<h2 id="how-do-i-create-a-tfrecords-file">
<a class="anchor" href="#how-do-i-create-a-tfrecords-file" aria-hidden="true"><span class="octicon octicon-link"></span></a>How do I create a TFRecords file?</h2>

<p>After having the dataset split and the vectorisers fitted, you can loop through the data splits, create a binary representation of each data point and save it to a <code class="language-plaintext highlighter-rouge">.tfrecords</code> file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cv2</span>


<span class="n">datasets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">train</span><span class="p">,</span> <span class="s">"train"</span><span class="p">),</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">"val"</span><span class="p">),</span> <span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s">".tfrecords"</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">python_io</span><span class="p">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">"image_path"</span><span class="p">]).</span><span class="n">tobytes</span><span class="p">()</span>

            <span class="n">description</span> <span class="o">=</span> <span class="n">text_encoder</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s">"description"</span><span class="p">]]</span>
            <span class="p">)</span>

            <span class="n">label_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">"label"</span><span class="p">])</span>

            <span class="n">example</span> <span class="o">=</span> <span class="n">serialize_example</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</code></pre></div></div>

<p>For reproducibility purposes, <code class="language-plaintext highlighter-rouge">text_encoder</code> is a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.CountVectorizer.html">CountVectorizer</a> object and <code class="language-plaintext highlighter-rouge">label_encoder</code> is a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.LabelBinarizer.html">LabelBinarizer</a> object.</p>

<div class="Toast">
   <span class="Toast-icon"><svg class="octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg></span>
   <span class="Toast-content">In case of using encoders for text and/or targets, I recommend to save their configuration in order to dynamically load the number of unique tokens and/or classes when training a model.</span>
</div>

<p>After running the snippets above you will create three files <code class="language-plaintext highlighter-rouge">train.tfrecords</code>, <code class="language-plaintext highlighter-rouge">val.tfrecords</code> and <code class="language-plaintext highlighter-rouge">test.tfrecords</code>!</p>

<h2 id="how-do-i-read-a-tfrecord-file">
<a class="anchor" href="#how-do-i-read-a-tfrecord-file" aria-hidden="true"><span class="octicon octicon-link"></span></a>How do I read a TFRecord file?</h2>
<p>First we need to create a representation of the feature we want to decode from each TFRecord:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">feature_description</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'label'</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="p">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s">'image'</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="p">.</span><span class="n">string</span><span class="p">),</span>
    <span class="s">'description'</span><span class="p">:</span> <span class="n">tf</span><span class="p">.</span><span class="n">SparseFeature</span><span class="p">(</span><span class="n">index_key</span><span class="o">=</span><span class="s">"description_index"</span><span class="p">,</span> <span class="n">value_key</span><span class="o">=</span><span class="s">"description_value"</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">description_max_features</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Luckily we have the ability to turn an array of indices and an array of values into a sparse feature without much hassle with <code class="language-plaintext highlighter-rouge">tf.SparseFeature</code>, just by specifying where to read the indices, values and the maximum length of the sparse representation. Please note that for every example: <code class="language-plaintext highlighter-rouge">len(indices) == len(values)</code> and <code class="language-plaintext highlighter-rouge">indices</code> should be contained in <code class="language-plaintext highlighter-rouge">[0,...,max_features-1]</code>.</p>

<p>Then we create a parsing function that reads the byte string of each example and decodes it:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_parse_function</span><span class="p">(</span><span class="n">example_proto</span><span class="p">):</span>
    <span class="n">example</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">example_proto</span><span class="p">,</span> <span class="n">feature_description</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s">"label"</span><span class="p">]</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s">"description"</span><span class="p">]</span>
    
    <span class="n">image_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">decode_raw</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s">"image"</span><span class="p">],</span> <span class="n">tf</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"description"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="s">"image"</span><span class="p">:</span><span class="n">image</span><span class="p">,</span>
    <span class="p">},</span> <span class="n">label</span>
</code></pre></div></div>

<p><strong>Tip:</strong> If you wish to turn a sparse tensor into dense you can use <a href="https://www.tensorflow.org/api_docs/python/tf/sparse/to_dense">tf.sparse.to_dense</a>.</p>

<p><strong>Tip:</strong> Using pre-trained imagenet weights?</p>

<p>If using an image model initialised with imagenet weights you should subtract the channel mean on each pixel using the below function. Also, channels will be swapped from RGB to BGR. This preprocessing stage guarantees that you will be sourcing images to the model following the same pixel value distribution per channel from the imagenet’s dataset.</p>

<p>The code block below is a simplified version of the current Keras <a href="https://github.com/keras-team/keras-applications/blob/master/keras_applications/imagenet_utils.py#L93">implementation</a> that assumes the <code class="language-plaintext highlighter-rouge">x</code> tensor to have color channels in the last dimension and channels input order should be RGB.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">preprocess_symbolic_input</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">backend</span>
    <span class="n">data_format</span> <span class="o">=</span> <span class="s">"channels_last"</span>

    <span class="c1"># 'RGB'-&gt;'BGR'
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[...,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">103.939</span><span class="p">,</span> <span class="mf">116.779</span><span class="p">,</span> <span class="mf">123.68</span><span class="p">]</span>

    <span class="n">mean_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="p">.</span><span class="n">constant</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean</span><span class="p">))</span>

    <span class="c1"># Zero-center by mean pixel
</span>    <span class="k">if</span> <span class="n">backend</span><span class="p">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="n">backend</span><span class="p">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">mean_tensor</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">backend</span><span class="p">.</span><span class="n">bias_add</span><span class="p">(</span>
            <span class="n">backend</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">backend</span><span class="p">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">mean_tensor</span><span class="p">)),</span>
            <span class="n">mean_tensor</span><span class="p">,</span>
            <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">backend</span><span class="p">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean_tensor</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="s">"channels_last"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></div>

<p>Finally, we create an helper to reads the datasets:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_dataset</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">shuffle</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">_parse_function</span><span class="p">)</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="s">"train.tfrecords"</span><span class="p">)</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="s">"val.tfrecords"</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="s">"test.tfrecords"</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="fitting-a-model">
<a class="anchor" href="#fitting-a-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fitting a model</h1>
<p>A TFRecord dataset is also know by its versatility since it can be used when fitting a <code class="language-plaintext highlighter-rouge">tf.keras.Model</code> (see <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#fit">docs</a>) and also when training an instance of <code class="language-plaintext highlighter-rouge">tf.estimator.Estimator</code> (see: <a href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator">docs</a> and <a href="https://www.tensorflow.org/guide/estimators">guide</a>).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">input_fn_train</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">repeat</span><span class="p">()</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="p">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">input_fn_eval</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">repeat</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dataset</span><span class="p">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<p>Voilà! You are now able to feed batches of tfrecords into your model!</p>

  </div><a class="u-url" href="/building-tfrecords-dataset/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Computers, software, machine learning, and other random thoughts.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/lagejoao" title="lagejoao"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/_joaolage" title="_joaolage"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
